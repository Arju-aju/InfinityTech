<%- include('./partials/adminHeader.ejs') %>
<script src="/js/editProduct.js" defer></script>

<div class="flex h-screen bg-gradient-to-br from-gray-900 via-purple-900 to-violet-900">
    <%- include('./partials/adminSidebar.ejs') %>

    <!-- Main Content -->
    <div class="flex-1 overflow-x-hidden overflow-y-auto">
        <div class="container mx-auto px-6 py-8">
            <!-- Breadcrumb -->
            <nav class="flex mb-8" aria-label="Breadcrumb">
                <ol class="inline-flex items-center space-x-1 md:space-x-3">
                    <li class="inline-flex items-center">
                        <a href="/admin/dashboard" class="text-gray-400 hover:text-white">Dashboard</a>
                    </li>
                    <li>
                        <div class="flex items-center">
                            <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg>
                            <a href="/admin/products" class="text-gray-400 hover:text-white ml-1 md:ml-2">Products</a>
                        </div>
                    </li>
                    <li aria-current="page">
                        <div class="flex items-center">
                            <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg>
                            <span class="text-gray-500 ml-1 md:ml-2">Edit Product</span>
                        </div>
                    </li>
                </ol>
            </nav>

            <div class="backdrop-blur-lg bg-gray-900/50 rounded-2xl p-8 max-w-4xl mx-auto shadow-2xl border border-gray-800">
                <% if (typeof message !== 'undefined') { %>
                    <div class="mb-6 p-4 rounded-lg backdrop-blur-sm <%= message.type === 'error' ? 'bg-red-500/20 text-red-100' : 'bg-green-500/20 text-green-100' %>">
                        <%= message.content %>
                    </div>
                <% } %>

                <form id="editProductForm" action="/admin/editProduct/<%= product._id %>" method="POST" enctype="multipart/form-data" class="space-y-8">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <!-- Left Column -->
                        <div class="space-y-6">
                            <div>
                                <label for="name" class="block text-sm font-medium text-gray-300 mb-2">Product Name*</label>
                                <input type="text" id="name" name="name" value="<%= product.name %>" required minlength="3"
                                    class="w-full px-4 py-3 rounded-lg bg-gray-800 border border-gray-700 text-white placeholder-gray-400 focus:border-cyan-500 focus:ring-2 focus:ring-cyan-500/50 transition-all duration-200">
                                <div class="error-message text-red-500 text-sm mt-1"></div>
                            </div>

                            <div>
                                <label for="brand" class="block text-sm font-medium text-gray-300 mb-2">Brand*</label>
                                <input type="text" id="brand" name="brand" value="<%= product.brand %>" required
                                    class="w-full px-4 py-3 rounded-lg bg-gray-800 border border-gray-700 text-white placeholder-gray-400 focus:border-cyan-500 focus:ring-2 focus:ring-cyan-500/50 transition-all duration-200">
                                <div class="error-message text-red-500 text-sm mt-1"></div>
                            </div>

                            <div>
                                <label for="description" class="block text-sm font-medium text-gray-300 mb-2">Description*</label>
                                <textarea id="description" name="description" required rows="4"
                                    class="w-full px-4 py-3 rounded-lg bg-gray-800 border border-gray-700 text-white placeholder-gray-400 focus:border-cyan-500 focus:ring-2 focus:ring-cyan-500/50 transition-all duration-200"><%= product.description %></textarea>
                                <div class="error-message text-red-500 text-sm mt-1"></div>
                            </div>

                            <div>
                                <label for="price" class="block text-sm font-medium text-gray-300 mb-2">Price*</label>
                                <input type="number" id="price" name="price" value="<%= product.price %>" required min="0" step="0.01"
                                    class="w-full px-4 py-3 rounded-lg bg-gray-800 border border-gray-700 text-white placeholder-gray-400 focus:border-cyan-500 focus:ring-2 focus:ring-cyan-500/50 transition-all duration-200">
                                <div class="error-message text-red-500 text-sm mt-1"></div>
                            </div>

                            <div>
                                <label for="stock" class="block text-sm font-medium text-gray-300 mb-2">Stock*</label>
                                <input type="number" id="stock" name="stock" value="<%= product.stock %>" required min="0"
                                    class="w-full px-4 py-3 rounded-lg bg-gray-800 border border-gray-700 text-white placeholder-gray-400 focus:border-cyan-500 focus:ring-2 focus:ring-cyan-500/50 transition-all duration-200">
                                <div class="error-message text-red-500 text-sm mt-1"></div>
                            </div>

                            <div>
                                <label for="discountPercentage" class="block text-sm font-medium text-gray-300 mb-2">Discount Percentage</label>
                                <input type="number" id="discountPercentage" name="discountPercentage" value="<%= product.discountPercentage %>" min="0" max="100"
                                    class="w-full px-4 py-3 rounded-lg bg-gray-800 border border-gray-700 text-white placeholder-gray-400 focus:border-cyan-500 focus:ring-2 focus:ring-cyan-500/50 transition-all duration-200">
                                <div class="error-message text-red-500 text-sm mt-1"></div>
                            </div>
                        </div>

                        <!-- Right Column -->
                        <div class="space-y-6">
                            <div>
                                <label for="category" class="block text-sm font-medium text-gray-300 mb-2">Category*</label>
                                <select id="category" name="category" required
                                    class="w-full px-4 py-3 rounded-lg bg-gray-800 border border-gray-700 text-white placeholder-gray-400 focus:border-cyan-500 focus:ring-2 focus:ring-cyan-500/50 transition-all duration-200">
                                    <% categories.forEach(cat => { %>
                                        <option value="<%= cat._id %>" <%= product.category?._id.toString() === cat._id.toString() ? 'selected' : '' %>>
                                            <%= cat.name %>
                                        </option>
                                    <% }); %>
                                </select>
                                <div class="error-message text-red-500 text-sm mt-1"></div>
                            </div>

                            <!-- Specifications -->
                            <div class="space-y-4">
                                <h3 class="text-lg font-medium text-gray-300">Specifications</h3>
                                
                                <div>
                                    <label for="processor" class="block text-sm font-medium text-gray-300 mb-2">Processor</label>
                                    <input type="text" id="processor" name="specifications[processor]" value="<%= product.specifications?.processor || '' %>"
                                        class="w-full px-4 py-3 rounded-lg bg-gray-800 border border-gray-700 text-white placeholder-gray-400 focus:border-cyan-500 focus:ring-2 focus:ring-cyan-500/50 transition-all duration-200">
                                </div>

                                <div>
                                    <label for="ram" class="block text-sm font-medium text-gray-300 mb-2">RAM</label>
                                    <input type="text" id="ram" name="specifications[ram]" value="<%= product.specifications?.ram || '' %>"
                                        class="w-full px-4 py-3 rounded-lg bg-gray-800 border border-gray-700 text-white placeholder-gray-400 focus:border-cyan-500 focus:ring-2 focus:ring-cyan-500/50 transition-all duration-200">
                                </div>

                                <div>
                                    <label for="storage" class="block text-sm font-medium text-gray-300 mb-2">Storage</label>
                                    <input type="text" id="storage" name="specifications[storage]" value="<%= product.specifications?.storage || '' %>"
                                        class="w-full px-4 py-3 rounded-lg bg-gray-800 border border-gray-700 text-white placeholder-gray-400 focus:border-cyan-500 focus:ring-2 focus:ring-cyan-500/50 transition-all duration-200">
                                </div>

                                <div>
                                    <label for="graphics" class="block text-sm font-medium text-gray-300 mb-2">Graphics</label>
                                    <input type="text" id="graphics" name="specifications[graphics]" value="<%= product.specifications?.graphics || '' %>"
                                        class="w-full px-4 py-3 rounded-lg bg-gray-800 border border-gray-700 text-white placeholder-gray-400 focus:border-cyan-500 focus:ring-2 focus:ring-cyan-500/50 transition-all duration-200">
                                </div>
                            </div>

                            <!-- Image Management -->
                            <div class="space-y-4">
                                <h3 class="text-lg font-medium text-gray-300">Current Images</h3>
                                <div class="grid grid-cols-2 gap-4">
                                    <% if (product.images && product.images.length > 0) { %>
                                        <% product.images.forEach(function(image, index) { %>
                                            <div class="relative group">
                                                <img src="<%= image %>" alt="Product image <%= index + 1 %>" class="w-full h-32 object-cover rounded-lg">
                                                <div class="absolute inset-0 bg-black bg-opacity-50 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                                    <button type="button" onclick="deleteImage('<%= index %>')" class="text-white bg-red-600 hover:bg-red-700 px-3 py-1 rounded-lg">
                                                        Delete
                                                    </button>
                                                </div>
                                                <input type="hidden" name="deleteImages" id="deleteImage<%= index %>" disabled>
                                            </div>
                                        <% }); %>
                                    <% } else { %>
                                        <p class="text-gray-400 col-span-2">No images uploaded yet</p>
                                    <% } %>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Add New Images</label>
                                <input type="file" id="newImages" name="images" multiple accept="image/*"
                                    class="w-full px-4 py-3 rounded-lg bg-gray-800 border border-gray-700 text-white placeholder-gray-400 focus:border-cyan-500 focus:ring-2 focus:ring-cyan-500/50 transition-all duration-200">
                                <p class="text-sm text-gray-400 mt-2">You can select multiple images. Supported formats: JPG, PNG, WEBP</p>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-between mt-8">
                        <button type="button" onclick="confirmDelete('<%= product._id %>')"
                            class="inline-flex items-center px-6 py-3 rounded-lg bg-red-600 hover:bg-red-500 text-white font-medium transition-all duration-200 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                            Delete Product
                        </button>
                        <button type="submit"
                            class="inline-flex items-center px-6 py-3 rounded-lg bg-cyan-600 hover:bg-cyan-500 text-white font-medium transition-all duration-200 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-cyan-500">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                            </svg>
                            Save Changes
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- SweetAlert2 for notifications -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
// Form validation
(function () {
    'use strict'
    var forms = document.querySelectorAll('.needs-validation')
    Array.prototype.slice.call(forms).forEach(function (form) {
        form.addEventListener('submit', function (event) {
            if (!form.checkValidity()) {
                event.preventDefault()
                event.stopPropagation()
            }
            form.classList.add('was-validated')
        }, false)
    })
})()

// Delete confirmation
function confirmDelete(productId) {
    Swal.fire({
        title: 'Are you sure?',
        text: "This product will be marked as deleted but retained in the database.",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Yes, delete it!'
    }).then((result) => {
        if (result.isConfirmed) {
            // Create a form and submit it
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/admin/deleteProduct/${productId}`;
            document.body.appendChild(form);
            form.submit();
        }
    })
}

// Delete image
function deleteImage(imageIndex) {
    Swal.fire({
        title: 'Delete Image?',
        text: "Are you sure you want to delete this image?",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Yes, delete it!'
    }).then((result) => {
        if (result.isConfirmed) {
            // Create a hidden input to track deleted images
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'deleteImages[]';
            input.value = imageIndex;
            document.getElementById('editProductForm').appendChild(input);
            
            // Hide the image visually
            const imageContainer = event.target.closest('.relative');
            imageContainer.style.display = 'none';
        }
    });
}

// Show success/error messages from flash
<% if (locals.success) { %>
    Swal.fire({
        icon: 'success',
        title: 'Success!',
        text: '<%= success %>',
        timer: 3000
    });
<% } %>

<% if (locals.error) { %>
    Swal.fire({
        icon: 'error',
        title: 'Error!',
        text: '<%= error %>',
        timer: 3000
    });
<% } %>
</script>

<%- include('./partials/adminFooter.ejs') %>
