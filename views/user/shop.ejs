<%- include('../partials/header') %>

<!-- Hero Section -->
<section class="relative bg-gradient-to-r from-gray-700 via-gray-900 to-black text-white py-20 overflow-hidden">
    <div class="absolute inset-0 bg-opacity-50 bg-black"></div>
    <div class="container mx-auto px-6 text-center relative z-10">
        <h1 class="text-4xl md:text-5xl font-bold mb-4 fade-in">Explore Our Laptop Collection</h1>
        <p class="text-lg md:text-xl slide-up">Find the perfect laptop for your needs with unbeatable deals!</p>
    </div>
</section>

<!-- Main Content -->
<div class="container mx-auto px-6 py-16">
    <!-- Filters -->
    <div class="bg-white p-8 rounded-xl shadow-2xl mb-16 card-hover">
        <div class="flex flex-wrap items-center gap-8 justify-center">
            <!-- Search Bar -->
            <div class="flex-grow max-w-md relative">
                <form action="/shop" method="GET" id="searchForm">
                    <input 
                        type="text" 
                        name="search" 
                        value="<%= locals.searchQuery || '' %>"
                        placeholder="Search laptops..."
                        class="w-full px-4 py-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-400 transition-all duration-300"
                    >
                    <button type="submit" class="absolute right-3 top-1/2 transform -translate-y-1/2">
                        <svg class="h-5 w-5 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </button>
                </form>
            </div>

            <!-- Category Dropdown -->
            <div class="relative">
                <select 
                    class="appearance-none bg-white border rounded-lg px-4 py-3 pr-10 focus:outline-none focus:ring-2 focus:ring-yellow-400 transition-all duration-300" 
                    id="categorySelect" 
                    onchange="filterByCategory(this.value)"
                >
                    <option value="">All Categories</option>
                    <% categories.forEach(category => { %>
                        <option value="<%= category._id %>" <%= selectedCategory === category._id ? 'selected' : '' %>><%= category.name %></option>
                    <% }) %>
                </select>
                <svg class="h-5 w-5 absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            </div>

            <!-- Price Range -->
            <div x-data="{ open: false }" class="relative">
                <button 
                    @click="open = !open" 
                    class="bg-white border rounded-lg px-4 py-3 flex items-center focus:outline-none focus:ring-2 focus:ring-yellow-400 transition-all duration-300"
                >
                    <span>Price Range</span>
                    <svg class="h-5 w-5 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </button>
                <div 
                    x-show="open" 
                    @click.away="open = false" 
                    x-transition
                    class="absolute right-0 mt-2 w-64 bg-white rounded-xl shadow-2xl p-4 z-50 slide-up"
                >
                    <div class="space-y-4">
                        <div class="flex space-x-4">
                            <input 
                                type="number" 
                                id="minPrice" 
                                value="<%= locals.selectedMinPrice || '' %>"
                                min="<%= locals.minPrice || 0 %>" 
                                max="<%= locals.maxPrice || 999999 %>"
                                placeholder="Min"
                                class="w-1/2 px-3 py-2 border rounded-lg focus:ring-2 focus:ring-yellow-400"
                            >
                            <input 
                                type="number" 
                                id="maxPrice" 
                                value="<%= locals.selectedMaxPrice || '' %>"
                                min="<%= locals.minPrice || 0 %>" 
                                max="<%= locals.maxPrice || 999999 %>"
                                placeholder="Max"
                                class="w-1/2 px-3 py-2 border rounded-lg focus:ring-2 focus:ring-yellow-400"
                            >
                        </div>
                        <button 
                            onclick="applyPriceFilter()"
                            class="w-full bg-yellow-400 text-gray-900 px-4 py-2 rounded-lg hover:bg-yellow-500 transition-all duration-300 font-semibold"
                        >
                            Apply
                        </button>
                    </div>
                </div>
            </div>

            <!-- Sort Dropdown -->
            <div class="relative">
                <select 
                    class="appearance-none bg-white border rounded-lg px-4 py-3 pr-10 focus:outline-none focus:ring-2 focus:ring-yellow-400 transition-all duration-300" 
                    id="sortSelect" 
                    onchange="filterBySort(this.value)"
                >
                    <option value="newest" <%= sortOption === 'newest' ? 'selected' : '' %>>New Arrivals</option>
                    <option value="price_low_to_high" <%= sortOption === 'price_low_to_high' ? 'selected' : '' %>>Price: Low to High</option>
                    <option value="price_high_to_low" <%= sortOption === 'price_high_to_low' ? 'selected' : '' %>>Price: High to Low</option>
                </select>
                <svg class="h-5 w-5 absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            </div>

            <!-- Reset Filters -->
            <button 
                onclick="resetFilters()" 
                class="bg-gray-200 text-gray-700 px-4 py-3 rounded-lg hover:bg-gray-300 transition-all duration-300 font-semibold"
            >
                Reset Filters
            </button>
        </div>
    </div>

    <!-- Product Grid -->
    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-10">
        <% if (typeof products !== 'undefined' && products.length > 0) { %>
            <% products.forEach(product => { %>
                <div class="bg-white rounded-xl shadow-lg card-hover overflow-hidden">
                    <div class="relative">
                        <a href="/product/<%= product._id %>">
                            <img src="<%= product.images[0] %>" alt="<%= product.name %>" class="w-full h-56 object-cover transition-transform duration-300 hover:scale-105">
                        </a>
                        <% if (product.offerDetails.discountPercentage > 0) { %>
                            <span class="absolute top-3 left-3 bg-yellow-400 text-gray-900 text-sm px-3 py-1 rounded-full font-semibold fade-in">
                                -<%= product.offerDetails.discountPercentage.toFixed(0) %>%
                            </span>
                        <% } %>
                        <button 
                            class="wishlist-btn absolute top-3 right-3 bg-white p-2 rounded-full shadow-md hover:bg-gray-100 transition-all duration-300"
                            data-product-id="<%= product._id %>"
                        >
                            <svg class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                            </svg>
                        </button>
                    </div>
                    <div class="p-6">
                        <a href="/product/<%= product._id %>">
                            <h3 class="text-lg font-semibold text-gray-800 mb-3 truncate slide-up"><%= product.name %></h3>
                            <div class="flex items-center justify-between mb-4">
                                <div>
                                    <% if (product.offerDetails.discountPercentage > 0) { %>
                                        <span class="text-gray-500 line-through">₹<%= product.offerDetails.originalPrice.toFixed(2) %></span>
                                        <span class="text-xl font-bold text-yellow-400 ml-2">₹<%= product.offerDetails.finalPrice.toFixed(2) %></span>
                                    <% } else { %>
                                        <span class="text-xl font-bold text-yellow-400">₹<%= product.price.toFixed(2) %></span>
                                    <% } %>
                                </div>
                                <span class="bg-green-100 text-green-800 text-sm px-2 py-0.5 rounded fade-in">New</span>
                            </div>
                        </a>
                        <div class="flex space-x-3">
                            <button 
                                class="add-to-cart-btn flex-1 bg-gray-100 hover:bg-gray-200 text-gray-800 py-2 rounded-lg text-sm font-semibold transition-all duration-300"
                                data-product-id="<%= product._id %>"
                            >
                                Add to Cart
                            </button>
                            <button 
                                class="buy-now-btn flex-1 bg-yellow-400 hover:bg-yellow-500 text-gray-900 py-2 rounded-lg text-sm font-semibold transition-all duration-300"
                                data-product-id="<%= product._id %>"
                            >
                                Buy Now
                            </button>
                        </div>
                    </div>
                </div>
            <% }) %>
        <% } else { %>
            <div class="col-span-full text-center text-gray-500 py-12 fade-in">
                <svg class="h-12 w-12 mx-auto mb-3 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0v6a4 4 0 01-4 4H8a4 4 0 01-4-4V7m16 0l-8 4m-8-4l8 4" />
                </svg>
                <p class="text-lg">No products available at the moment. Check back soon!</p>
            </div>
        <% } %>
    </div>

    <!-- Pagination -->
    <% if (totalPages > 1) { %>
        <div class="mt-12 flex justify-center">
            <nav class="inline-flex rounded-xl shadow-lg bg-white">
                <% if (currentPage > 1) { %>
                    <a href="/shop?page=<%= currentPage - 1 %><%= searchQuery ? '&search=' + searchQuery : '' %><%= selectedCategory ? '&category=' + selectedCategory : '' %><%= sortOption ? '&sort=' + sortOption : '' %>" class="px-4 py-3 text-sm font-semibold text-gray-700 border border-gray-300 rounded-l-xl hover:bg-gray-100 transition-all duration-300">
                        <svg class="h-5 w-5 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                        Previous
                    </a>
                <% } %>
                <% for (let i = 1; i <= totalPages; i++) { %>
                    <a href="/shop?page=<%= i %><%= searchQuery ? '&search=' + searchQuery : '' %><%= selectedCategory ? '&category=' + selectedCategory : '' %><%= sortOption ? '&sort=' + sortOption : '' %>" class="px-4 py-3 text-sm font-semibold <%= currentPage === i ? 'bg-yellow-400 text-gray-900' : 'bg-white text-gray-700' %> border border-gray-300 hover:bg-gray-100 transition-all duration-300">
                        <%= i %>
                    </a>
                <% } %>
                <% if (currentPage < totalPages) { %>
                    <a href="/shop?page=<%= currentPage + 1 %><%= searchQuery ? '&search=' + searchQuery : '' %><%= selectedCategory ? '&category=' + selectedCategory : '' %><%= sortOption ? '&sort=' + sortOption : '' %>" class="px-4 py-3 text-sm font-semibold text-gray-700 border border-gray-300 rounded-r-xl hover:bg-gray-100 transition-all duration-300">
                        Next
                        <svg class="h-5 w-5 inline ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                    </a>
                <% } %>
            </nav>
        </div>
    <% } %>
</div>

<%- include('../partials/footer') %>

<!-- Script Section -->
<script>
function updateUrl(params) {
    const url = new URL(window.location);
    Object.keys(params).forEach(key => {
        if (params[key] || params[key] === 0) url.searchParams.set(key, params[key]);
        else url.searchParams.delete(key);
    });
    window.history.pushState({}, '', url);
    window.location.reload();
}

function filterByCategory(categoryId) {
    updateUrl({ category: categoryId, page: 1 });
}

function filterBySort(sortValue) {
    updateUrl({ sort: sortValue });
}

function applyPriceFilter() {
    const minPrice = document.getElementById('minPrice').value;
    const maxPrice = document.getElementById('maxPrice').value;
    updateUrl({ minPrice, maxPrice, page: 1 });
}

function resetFilters() {
    updateUrl({ category: '', sort: 'newest', minPrice: '', maxPrice: '', search: '', page: 1 });
}

document.addEventListener('DOMContentLoaded', () => {
    const searchForm = document.getElementById('searchForm');
    searchForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const search = e.target.search.value;
        updateUrl({ search, page: 1 });
    });

    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('fade-in');
                observer.unobserve(entry.target);
            }
        });
    }, { threshold: 0.1 });

    document.querySelectorAll('.card-hover, .fade-in').forEach(el => {
        observer.observe(el);
    });
});
</script>